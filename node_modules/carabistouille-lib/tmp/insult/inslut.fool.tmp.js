var restclient = require('node-restclient');
var Twit = require('twit');
var app = require('express').createServer();
var fs = require("fs");

// I deployed to Nodejitsu, which requires an application to respond to HTTP requests
// If you're running locally you don't need this, or express at all.
//app.get('/', function(req, res){
//    res.send('Hello world.');
//});
//app.listen(3000);

// insert your twitter app info here
var T = new Twit({
  consumer_key:         'AG7tBD50fTSX6p5rvcXD3iFwN', 
  consumer_secret:      'iv8qbfAmYQE8DHEhlsT04hXRinnP7CaEZLUZ3ArCP2hfr3J8wt',
  access_token:         '4878139721-mt72Sv2vXrmVrpX9bTTTLVyyx4MG0yQTN4QfiXF',
  access_token_secret:  'oQypl8QutsvMn23kZjZuqNF97U0P5gvEmvQKeQNQmrUvZ'
});

var sys = require('sys')

var exec = require('child_process').exec;

var child;

// executes `pwd`

child = exec("pwd", function (error, stdout, stderr) {

//  sys.print('stdout: ' + stdout);

//  sys.print('stderr: ' + stderr);

  if (error !== null) {

    console.log('exec error: ' + error);

  }

});

// or more concisely

var sys = require('sys')

var exec = require('child_process').exec;

function puts(error, stdout, stderr) { //sys.puts(stdout) 
}

function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

String.prototype.replaceAt=function(index, character) {
    return this.substr(0, index) + character + this.substr(index+character.length);
}

function startWithAVoyelle(string)
{
	if (string.charAt(0) == "a" || 
			string.charAt(0) == "e" || 
			string.charAt(0) == "i" || 
			string.charAt(0) == "o" || 
			string.charAt(0) == "u" || 
			string.charAt(0) == "h")
	{
		return true;
	}
	return false;
}

var statement =   "";

var accroches = ["espèce de ", "tu t'es vu avec ta face de ", "rentre chez toi, ", "", "", "", "", "rentre chez ta mère, ", "hé, ", "passe ton chemin, " ]
var accrocheSansArticles = ["t'es qu'", "t'as la gueule d'"]
var noms = ["hippie", "hipster", "communiste", "nazi", "clown", "nerd", "prout", "pirate", "quadrupède", "aztèque", "ivrogne", "macaque", "technocrate", "vampire", "environementaliste"]
var nomsF = ["raclure", "pourriture", "chaussette", "mule", "limace", "huître", "horloge murale", "carie", "chèvre", "pile", "crème pâtissière", "annesse", "niche", "camionnette", "machine à laver", "baignoire", "pastèque", "bossue", "chauve-souris", "flaque", "luge", "gourgandine", "antiquité", "caisse", "pantoufle", "cornemuse", "patate", "végétarienne", "perruche", "farceuse", "boite de conserve", "graine", "brouette", "scélérate", "délinquante", "levure", "gorge", "machine à écrire", "mononucléose", "mamie", "gobeuse de mouches"]
var nomsM = ["canoe", "jambon", "hibou", "caniveau", "gaufrier", "biscuit", "montagnard", "goblin", "mangeur de tarte", "dromadaire", "bâteau à voile", "fakir", "monosourcil", "pneu creuvé", "fond de placard", "poil de nez", "corps au pied", "accordéon", "poney", "sac à douche", "égoutoir", "zèbre", "clairon", "post-it", "robinet", "bossu", "rouleau à pâtisserie", "igloo", "benne à ordure", "chiffon", "poulpe", "fémur", "ravioli", "apache", "athlète", "bandit", "bibelot", "cornichon", "chaufard", "cigare", "diplodocus", "galopin", "hydrocarbure", "tapis", "topinambour", "végétarien", "farceur", "mille-pattes", "chercheur", "convoyeur", "scélérat", "délinquant", "loubard", "orifice", "enzyme", "épouvantail", "lombric", "brouillon", "déserteur", "vendeur de mort", "papy", "gobeur de mouches", "mime", "apiculteur"]
var adjectifs = ["étrange", "communiste", "de mes deux", "stupide", "ignoble", "aveugle", "immense", "zinzin", "sans fond", "convexe", "en plastique", "de mauvaise famille", "verdâtre", "analphabète", "mégalomane", "ramollie", "interplanétaire", "en chaussette", "bancale", "indéchiffrable", "angoissant", "lubrique", "tolérable", "vulgaire", "minable", "négligeable", "pas pire", "convenable", "cataclysmique", "catastrophique", "boute-en-train", "épouventable", "innommable", "incrédule"]
var adjectifsF = ["puante", "ideuse", "dégénérée", "pas belle", "bruyante", "usagée", "trouée", "dissonante", "pas fraiche", "manquée", "ancienne", "pas terminée", "bossue", "cabossée", "boueuse", "dévergondée", "maquillée", "volante", "hurluberlue", "vénéneuse", "écervelée", "revendicatrice", "absolue", "recyclée", "pas satisfaisante", "disjonctée", "ennuyante", "insuffisante", "insignifiante", "infernale"]
var adjectifsM = ["puant", "ideux", "dégénéré", "pas beau", "bruyant", "usagé", "troué", "dissonant", "pas frais", "manqué", "ancien", "pas terminé", "bossu", "cabossé", "boueux", "niais", "dévergondé", "maquillé", "volant", "hurluberlu", "vénéneux", "écervelé", "revendicateur", "absolu", "recyclé", "pas satisfaisant", "disjoncté", "ennuyant", "insuffisant", "insignifiant", "infernal"]

var allAdjectifs = adjectifs.concat(adjectifsF);
allAdjectifs = allAdjectifs.concat(adjectifsM);



function makeStatement() {
  statement = "Je t'aime !";

statement += " !";
statement = capitalizeFirstLetter(statement);
return statement;

}


function makeMetaphor() {
var statement = makeStatement();
setTimeout(function () {
	console.log(statement);
exec("espeak \"" + statement + "\" -vfr+m3 -g 15mS -w /home/rguyard/insult/inslut.wav && ffmpeg -i inslut.wav inslut.mp3", puts);
exec("espeak \"" + statement + "\" -vfr+m3 -g 15mS -w /home/rguyard/insult/inslut.wav && ffmpeg -loop 1 -i img001.jpg -i inslut.wav -c:v libx264 -c:a aac -strict experimental -b:a 192k -shortest -vf format=yuv420p -y inslut.mp4", puts);

var filePath = '/home/rguyard/insult/inslut.mp4'
T.postMediaChunked({ status: statement, file_path: filePath }, function (err, data, response) {
  console.log(data)
  var mediaIdStr = data.media_id_string
        T.post('statuses/update', { status: statement, media_ids: [mediaIdStr] }, function(err, reply) {
          console.log("error: " + err);
          console.log("reply: " + reply);
        });
})

//var b64content = fs.readFileSync('./insult.wav', { encoding: 'base64' });

// first we must post the media to Twitter
//T.post('media/upload', { media_data: b64content }, function (err, data, response) {
//          console.log("reponse: " + err.stack);
//          console.log("reponse: " + response);
//          console.log("reponse: " + data);

  // now we can reference the media and post a tweet (media will attach to the tweet)
//  var mediaIdStr = data.media_id_string

//        T.post('statuses/update', { status: statement, media_ids: [mediaIdStr] }, function(err, reply) {
  //        console.log("error: " + err);
  //        console.log("reply: " + reply);
  //      });
//	});
}, 500);


}

var stream = T.stream('statuses/filter', { track: ['robien', 'robienTeDeteste'] })

stream.on('tweet', function (tweet) {
if (tweet.user.screen_name != "robienTeDeteste")
{
//if (tweet.user.screen_name.indexOf("JonathanKaizen") <= -1)
//{
//    console.log("not a tweet from Jo");

//}
//if (tweet.text.indexOf("robien") == -1 && tweet.user.screen_name.indexOf("JonathanKaizen") <= -1)
//{
//return;
//}
    console.log(tweet);
var statement = "@" + tweet.user.screen_name + " " + makeStatement();
var tweetToReplyId = "" + tweet.id_str;
    console.log("@" + tweet.user.screen_name+" said: " + tweet.text + " tweet id: " + tweetToReplyId);
        T.post('statuses/update', { status: statement, in_reply_to_status_id: tweetToReplyId}, function(err, reply) {
          console.log("error: ");
          console.log(err);
          console.log("reply: ");
          console.log(reply);
        });

}

})


function favRTs () {
  T.get('statuses/retweets_of_me', {}, function (e,r) {
    for(var i=0;i<r.length;i++) {
      T.post('favorites/create/'+r[i].id_str,{},function(){});
    }
    console.log('harvested some RTs'); 
  });
}

// every 2 minutes, make and tweet a metaphor
// wrapped in a try/catch in case Twitter is unresponsive, don't really care about error
// handling. it just won't tweet.
//setInterval(function() {
//  try {
//    makeMetaphor();
//  }
// catch (e) {
//    console.log(e);
//  }
//},1200000);
//    makeMetaphor();

// every 5 hours, check for people who have RTed a metaphor, and favorite that metaphor
setInterval(function() {
  try {
    favRTs();
  }
 catch (e) {
    console.log(e);
  }
},60000*60*5);

